<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://yl.frontjs.cc">
  <title>关于js异步上传文件 | YL&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文首发在我的博客园：http://www.cnblogs.com/yuanlong1012/p/5127497.html  最近项目里有个需求，上传文件（好吧，这种需求很常见，这也不是第一次遇到了）。当时第一想法就是直接用form表单提交（原谅我以前就是这么干的），不过表单里不仅有文件还有别的信息需要交互，跟后端商量后决定文件单独上传，获取到服务器端返回的文件地址在和表单一起提交。这里就需要异">
<meta name="keywords" content="js,文件上传">
<meta property="og:type" content="article">
<meta property="og:title" content="关于js异步上传文件">
<meta property="og:url" content="https://yl.frontjs.cc/2016/03/08/2016-03-08-file-upload/index.html">
<meta property="og:site_name" content="YL&#39;s Blog">
<meta property="og:description" content="本文首发在我的博客园：http://www.cnblogs.com/yuanlong1012/p/5127497.html  最近项目里有个需求，上传文件（好吧，这种需求很常见，这也不是第一次遇到了）。当时第一想法就是直接用form表单提交（原谅我以前就是这么干的），不过表单里不仅有文件还有别的信息需要交互，跟后端商量后决定文件单独上传，获取到服务器端返回的文件地址在和表单一起提交。这里就需要异">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113143715944-686026729.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113154319132-891661887.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113154331335-1308230912.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113154343678-1782738937.png">
<meta property="og:updated_time" content="2018-07-24T07:44:25.200Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于js异步上传文件">
<meta name="twitter:description" content="本文首发在我的博客园：http://www.cnblogs.com/yuanlong1012/p/5127497.html  最近项目里有个需求，上传文件（好吧，这种需求很常见，这也不是第一次遇到了）。当时第一想法就是直接用form表单提交（原谅我以前就是这么干的），不过表单里不仅有文件还有别的信息需要交互，跟后端商量后决定文件单独上传，获取到服务器端返回的文件地址在和表单一起提交。这里就需要异">
<meta name="twitter:image" content="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113143715944-686026729.png">
  
    <link rel="alternative" href="/atom.xml" title="YL&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xrl5v.com1.z0.glb.clouddn.com/github/io/logo.png">
  
  <link rel="stylesheet" href="/main.css?v=4.0.0">
  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="http://7xrl5v.com1.z0.glb.clouddn.com/github/io/logo.png" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">YuanLong</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a data-idx="0" q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a data-idx="1" q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a data-idx="2" q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/yl2014" title="github"><i class="icon-github"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-sort"></i></div>
  		<h1 class="header-author js-mobile-header hide">YuanLong</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://7xrl5v.com1.z0.glb.clouddn.com/github/io/logo.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">YuanLong</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
		        
		        	<li><a href="/archives/">所有文章</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/yl2014" title="github"><i class="icon-github"></i></a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-2016-03-08-file-upload" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      关于js异步上传文件
    </h1>
  

        <a href="/2016/03/08/2016-03-08-file-upload/" class="archive-article-date">
  	<time datetime="2016-03-08T09:34:59.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2016-03-08</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文首发在我的博客园：<a href="http://www.cnblogs.com/yuanlong1012/p/5127497.html" target="_blank" rel="noopener">http://www.cnblogs.com/yuanlong1012/p/5127497.html</a></p>
</blockquote>
<p>最近项目里有个需求，上传文件（好吧，这种需求很常见，这也不是第一次遇到了）。当时第一想法就是直接用form表单提交（原谅我以前就是这么干的），不过表单里不仅有文件还有别的信息需要交互，跟后端商量后决定文件单独上传，获取到服务器端返回的文件地址在和表单一起提交。这里就需要异步上传文件。<br>　　在网上扒了扒相关的内容，发现还真不少，阮一峰老师的这篇文章<a href="http://www.ruanyifeng.com/blog/2012/08/file_upload.html" target="_blank" rel="noopener">文件上传的渐进式增强</a>就介绍的很具体，下面就谈谈自己在实战中遇到的一些问题的感受吧。</p>
<a id="more"></a>
<p>　　先看看效果，实现了哪些功能</p>
<p><img src="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113143715944-686026729.png" alt="">（好吧，就一个按钮而已，搞得神神秘秘，嘿嘿）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn"</span> @<span class="attr">click</span>=<span class="string">"upload"</span>&gt;</span>点击上传文件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>给按钮绑定了一个点击事件，下面看看点击事件方法里做了什么</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">methods: &#123;</span><br><span class="line">    upload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        myUpload(&#123;</span><br><span class="line">            url: <span class="built_in">window</span>.location.protocol + <span class="string">'//'</span> + <span class="built_in">window</span>.location.host + <span class="string">'/crm/upload'</span>,</span><br><span class="line">            maxSize: <span class="number">10</span>,</span><br><span class="line">            beforeSend: <span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            callback: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res);</span><br><span class="line">                pageCont.attachmentUrl = data.url;</span><br><span class="line">            &#125;,</span><br><span class="line">            uploading: <span class="function"><span class="keyword">function</span>(<span class="params">pre</span>)</span>&#123;</span><br><span class="line">                pageCont.uploadCont.display = <span class="string">'block'</span>;</span><br><span class="line">                pageCont.uploadStyle.width = pre * <span class="number">2</span> + <span class="string">'px'</span>;</span><br><span class="line">                pageCont.pre = pre;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按钮绑定的点击事件执行了upload方法，在upload方法里调用了一下myUpload方法，并传递了一些配置信息进去，稍后说下这些配置信息。先看看myUpload的具体实现：</p>
<p>　　初始化了一个FormData对象和一个XMHttpResquest对象，创建一个type为file的input，并触发一次该input的click，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fd = <span class="keyword">new</span> FormData(),</span><br><span class="line">    xhr = <span class="keyword">new</span> XMLHttpRequest(),</span><br><span class="line">    input;</span><br><span class="line">input = <span class="built_in">document</span>.createElement(<span class="string">'input'</span>);</span><br><span class="line">input.setAttribute(<span class="string">'id'</span>, <span class="string">'myUploadInput'</span>);</span><br><span class="line">input.setAttribute(<span class="string">'type'</span>, <span class="string">'file'</span>);</span><br><span class="line">input.setAttribute(<span class="string">'name'</span>, <span class="string">'file'</span>);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(input);</span><br><span class="line">input.style.display = <span class="string">'none'</span>;</span><br><span class="line">input.click();</span><br></pre></td></tr></table></figure>
<p>监听刚才创建的input的change事件，并作在里面做相应处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">input.onchange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!input.value)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">    <span class="keyword">if</span>(option.maxSize &amp;&amp;  input.files[<span class="number">0</span>].size &gt; option.maxSize * <span class="number">1024</span> * <span class="number">1024</span>)&#123;</span><br><span class="line">        dialog(&#123;</span><br><span class="line">            title: <span class="string">'提示'</span>,</span><br><span class="line">            content: <span class="string">'请上传小于'</span>+option.maxSize+<span class="string">'M的文件'</span>,</span><br><span class="line">            okValue: <span class="string">'确定'</span>,</span><br><span class="line">            ok: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">        &#125;).showModal();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(option.beforeSend <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(option.beforeSend(input) === <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fd.append(<span class="string">'file'</span>, input.files[<span class="number">0</span>]);</span><br><span class="line">    xhr.open(<span class="string">'post'</span>, option.url);</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.status == <span class="number">200</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(option.callback <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">                    option.callback(xhr.responseText);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!(dialog.get(<span class="string">'uploadfail'</span>)))&#123;</span><br><span class="line">                dialog(&#123;</span><br><span class="line">                    id: <span class="string">'uploadfail'</span>,</span><br><span class="line">                    title: <span class="string">'提示'</span>,</span><br><span class="line">                    content: <span class="string">'上传失败'</span>,</span><br><span class="line">                    okValue: <span class="string">'确定'</span>,</span><br><span class="line">                    ok: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">                &#125;).showModal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.upload.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> pre = <span class="built_in">Math</span>.floor(<span class="number">100</span> * event.loaded / event.total);</span><br><span class="line">        <span class="keyword">if</span>(option.uploading <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">            option.uploading(pre);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.send(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释下上面的代码。input的change事件触发后，首先判断了下当前是否选择了文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!input.value)&#123;<span class="keyword">return</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>一开始我是没做这个判断的，在后来的测试过程中发现，当上传一次文件后，再次点击按钮上传，打开文件选择框，然后不选择文件，而是点击取消按钮，change事件也触发了，导致后面的代码也会执行，显然这不合理，故加了这个判断。</p>
<p>　　然后限制了下上传文件的大小（这样的事能够前端处理就不要交给服务端来验证了），当文件大小超过最大限制，就会弹框提示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(option.maxSize &amp;&amp;  input.files[<span class="number">0</span>].size &gt; option.maxSize * <span class="number">1024</span> * <span class="number">1024</span>)&#123;</span><br><span class="line">    dialog(&#123;</span><br><span class="line">        title: <span class="string">'提示'</span>,</span><br><span class="line">        content: <span class="string">'请上传小于'</span>+option.maxSize+<span class="string">'M的文件'</span>,</span><br><span class="line">        okValue: <span class="string">'确定'</span>,</span><br><span class="line">        ok: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;).showModal();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后加了一个文件上传前的操作，可以在文件上传前做一些处理，如进度条的显示，图片预览等等</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(option.beforeSend <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(option.beforeSend(input) === <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来将文件append到formData对象里，使用字段名‘file’，该字段名是服务端接收文件时使用的字段名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd.append(<span class="string">'file'</span>, input.files[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>然后就是使用XMLHttpRequest对象向服务端发送数据了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(<span class="string">'post'</span>, option.url);</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(xhr.status == <span class="number">200</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(option.callback <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">                option.callback(xhr.responseText);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!(dialog.get(<span class="string">'uploadfail'</span>)))&#123;</span><br><span class="line">            dialog(&#123;</span><br><span class="line">                id: <span class="string">'uploadfail'</span>,</span><br><span class="line">                title: <span class="string">'提示'</span>,</span><br><span class="line">                content: <span class="string">'上传失败'</span>,</span><br><span class="line">                okValue: <span class="string">'确定'</span>,</span><br><span class="line">                ok: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">            &#125;).showModal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xhr.upload.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pre = <span class="built_in">Math</span>.floor(<span class="number">100</span> * event.loaded / event.total);</span><br><span class="line">    <span class="keyword">if</span>(option.uploading <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">        option.uploading(pre);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xhr.send(fd);</span><br></pre></td></tr></table></figure>
<p>再向服务端发送数据时，使用了监听了一下progress事件，主要是为了进行上传进度的显示，上述代码中，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pre = <span class="built_in">Math</span>.floor(<span class="number">100</span> * event.loaded / event.total);</span><br></pre></td></tr></table></figure>
<p>获取上传的百分比，能够拿到这个值，页面上就可以展示各种各样的上传进度效果了。</p>
<p>　　差不多介绍完了，下面补充一下使用中遇到的问题：</p>
<p>　　问题一：文件在上传的过程中，使用JSON.parse()序列化服务端返回的json字符串报错(傻啊，文件还在上传，服务端怎么会返回数据啊)。</p>
<p>事情是这样的，一开始，我在readystatechange里只监听了状态码是否是200，如果是就说明通了，然后执行回调，在回调里处理服务端返回的数据，但是通了不一定代表服务端已经返回了数据，所以就出现了上面的错误，所以后来在判断了status是否为200后，还判断了readyState，以确保服务端已处理完毕并返回数据在执行回调</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(xhr.status == <span class="number">200</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(option.callback <span class="keyword">instanceof</span> <span class="built_in">Function</span>)&#123;</span><br><span class="line">        option.callback(xhr.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题二：重复创建input。每次点击按钮上传文件后，页面都会多一个type=file的input感觉不是很好（个人癖好吧），所以对最开始的初始化代码做了下优化，判断当前页面是否存在刚才创建的input，存在就直接使用，不存在就创建，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">document</span>.getElementById(<span class="string">'myUploadInput'</span>))&#123;</span><br><span class="line">    input = <span class="built_in">document</span>.getElementById(<span class="string">'myUploadInput'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    input = <span class="built_in">document</span>.createElement(<span class="string">'input'</span>);</span><br><span class="line">    input.setAttribute(<span class="string">'id'</span>, <span class="string">'myUploadInput'</span>);</span><br><span class="line">    input.setAttribute(<span class="string">'type'</span>, <span class="string">'file'</span>);</span><br><span class="line">    input.setAttribute(<span class="string">'name'</span>, <span class="string">'file'</span>);</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(input);</span><br><span class="line">    input.style.display = <span class="string">'none'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，就这么多了。看看效果<br><img src="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113154319132-891661887.png" alt=""><br><img src="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113154331335-1308230912.png" alt=""><br><img src="http://images2015.cnblogs.com/blog/695097/201601/695097-20160113154343678-1782738937.png" alt=""></p>
<p>刚才加了个需求，限制上传文件类型，作了如下修改：</p>
<ul>
<li>myUpload方法，初始化时增加了支持文件类型，如下</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fileType = [<span class="string">'doc'</span>,<span class="string">'docx'</span>,<span class="string">'xls'</span>,<span class="string">'xlsx'</span>,<span class="string">'pdf'</span>,<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'ppt'</span>,<span class="string">'pptx'</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>change发生后，检查文件类型，如下</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> type = input.value.split(<span class="string">'.'</span>).pop();</span><br><span class="line"><span class="keyword">if</span>(fileType.indexOf(type.toLocaleLowerCase()) == <span class="number">-1</span>)&#123;</span><br><span class="line">    dialog(&#123;</span><br><span class="line">        title: <span class="string">'提示'</span>,</span><br><span class="line">        content: <span class="string">'暂不支持该类型的文件，请重新选择!'</span>,</span><br><span class="line">        okValue: <span class="string">'确定'</span>,</span><br><span class="line">        ok: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;).showModal();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因个人知识面有限，如有错误，还请指正。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/文件上传/">文件上传</a></li></ul>
	</div>

      

      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=https://yl.frontjs.cc/2016/03/08/2016-03-08-file-upload/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2016/03/09/2016-03-09-crm-share/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          CRM前端架构分享
        
      </div>
    </a>
  
  
    <a href="/2016/03/06/2016-03-06-chrome-tip-snippets/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">chrome使用技巧之snippets</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2016-03-08-file-upload" data-title="关于js异步上传文件" data-url="https://yl.frontjs.cc/2016/03/08/2016-03-08-file-upload/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"yl2014-github-io"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 YuanLong
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js?v=4.0.0"></script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">jekyll</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">blog</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">js</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">文件上传</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">chrome</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">snippets</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">crm</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">ssd</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">微信</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">又拍云</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">ecs</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">ftp</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">ubuntu</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">nodejs</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">let's encrype</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">https</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">git</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://aotu.io/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>凹凸实验室</a>
            </li>
          
            <li class="search-li">
              <a href="http://dancdx.github.io/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>dancdx&#39;s blog</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">搬砖中...</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>